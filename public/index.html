<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Network Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui; margin: 2rem; max-width: 600px; }
    input, button { padding: 0.6rem; width: 100%; margin-bottom: 1rem; }
    button { cursor: pointer; }
    #logBox {
      border: 1px solid #ccc;
      padding: 1rem;
      height: 250px;
      overflow-y: auto;
      background: #fafafa;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>Network Monitor</h1>
<p>Enter your name and unit to begin monitoring.</p>

<label>Name</label>
<input id="nameInput" placeholder="Your name">

<label>Unit</label>
<input id="unitInput" placeholder="Your unit (e.g., 3B, 4345 #2)">

<button onclick="startMonitoring()">Start Monitoring</button>

<h2>Live Log Output</h2>
<div id="logBox">(waiting to startâ€¦)</div>

<script>
let sessionId = null;
let userName = null;
let userUnit = null;
let pingInterval = null;

function logMessage(msg) {
  const box = document.getElementById("logBox");
  const timestamp = new Date().toLocaleTimeString();
  box.textContent += `[${timestamp}] ${msg}\n`;
  box.scrollTop = box.scrollHeight;
}

function startMonitoring() {
  userName = document.getElementById("nameInput").value.trim();
  userUnit = document.getElementById("unitInput").value.trim();

  if (!userName || !userUnit) {
    alert("Please enter both name and unit.");
    return;
  }

  sessionId = Date.now() + "-" + Math.random().toString(36).slice(2);

  logMessage(`Monitoring started for ${userName} (${userUnit})`);
  sendEvent({ eventType: "session-start" });

  startPingLoop();

  window.addEventListener("offline", () => {
    logMessage("Browser went OFFLINE");
    sendEvent({ eventType: "offline-event" });
  });

  window.addEventListener("online", () => {
    logMessage("Browser went ONLINE");
    sendEvent({ eventType: "online-event" });
  });

  window.addEventListener("beforeunload", () =>
    sendEvent({ eventType: "session-end", reason: "page-unload" })
  );
}

function sendEvent(event) {
  // Attach metadata to EVERY event
  event.sessionId = sessionId;
  event.name = userName;
  event.unit = userUnit;
  event.timestamp = new Date().toISOString();
  event.navigatorOnline = navigator.onLine;
  event.userAgent = navigator.userAgent;

  fetch("/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(event)
  }).catch(err => console.error("Failed to send event:", err));
}

function startPingLoop() {
  async function ping() {
    const start = performance.now();

    try {
      const res = await fetch("/ping");
      const latency = Math.round(performance.now() - start);

      logMessage(`Ping: ${latency} ms`);

      sendEvent({
        eventType: "ping",
        ok: res.ok,
        status: res.status,
        latencyMs: latency
      });

    } catch (err) {
      logMessage(`Ping failed: ${err}`);
      sendEvent({
        eventType: "ping",
        ok: false,
        error: err.toString()
      });
    }
  }

  ping();
  pingInterval = setInterval(ping, 10000); // every 10 seconds
}
</script>

</body>
</html>

