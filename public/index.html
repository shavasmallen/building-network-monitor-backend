<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Network Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui; margin: 2rem; max-width: 600px; }
    input, button { padding: 0.6rem; width: 100%; margin-bottom: 1rem; }
    button { cursor: pointer; }
  </style>
</head>
<body>

<h1>Network Monitor</h1>
<p>Enter your name and unit to begin monitoring.</p>

<label>Name</label>
<input id="nameInput" placeholder="Your name">

<label>Unit</label>
<input id="unitInput" placeholder="Your unit (e.g., 3B, 4345 #2)">

<button onclick="startMonitoring()">Start Monitoring</button>

<script>
let sessionId = null;
let userName = null;
let userUnit = null;
let pingInterval = null;

function startMonitoring() {
  userName = document.getElementById("nameInput").value.trim();
  userUnit = document.getElementById("unitInput").value.trim();

  if (!userName || !userUnit) {
    alert("Please enter both name and unit.");
    return;
  }

  sessionId = Date.now() + "-" + Math.random().toString(36).slice(2);

  sendEvent({
    eventType: "session-start",
    name: userName,
    unit: userUnit
  });

  startPingLoop();

  window.addEventListener("offline", () =>
    sendEvent({ eventType: "offline-event" })
  );

  window.addEventListener("online", () =>
    sendEvent({ eventType: "online-event" })
  );

  window.addEventListener("beforeunload", () =>
    sendEvent({ eventType: "session-end", reason: "page-unload" })
  );

  alert("Monitoring started. Keep this page open.");
}

function sendEvent(event) {
  // Attach metadata to EVERY event
  event.sessionId = sessionId;
  event.name = userName;
  event.unit = userUnit;
  event.timestamp = new Date().toISOString();
  event.navigatorOnline = navigator.onLine;
  event.userAgent = navigator.userAgent;

  fetch("/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(event)
  }).catch(err => console.error("Failed to send event:", err));
}

function startPingLoop() {
  async function ping() {
    const start = performance.now();

    try {
      const res = await fetch("/ping");
      const latency = performance.now() - start;

      sendEvent({
        eventType: "ping",
        ok: res.ok,
        status: res.status,
        latencyMs: Math.round(latency)
      });

    } catch (err) {
      sendEvent({
        eventType: "ping",
        ok: false,
        error: err.toString()
      });
    }
  }

  ping();
  pingInterval = setInterval(ping, 10000); // every 10 seconds
}
</script>

</body>
</html>

