<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Network Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui; margin: 2rem; }
    #liveLog {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      background: #fafafa;
      margin-top: 1rem;
    }
    .log-line { font-family: monospace; margin: 2px 0; }
    .log-success { color: #15803d; }   /* green */
    .log-failure { color: #b91c1c; }   /* red */
    .log-info { color: #1e3a8a; }      /* blue */
  </style>
</head>
<body>

<h1>Network Monitor</h1>
<p>Live connectivity and latency logging.</p>

<div>
  <strong>Status Log:</strong>
  <div id="liveLog"></div>
</div>

<script>
// Identify this device
const name = localStorage.getItem("monitorName") || prompt("Enter your name:");
localStorage.setItem("monitorName", name);

const unit = localStorage.getItem("monitorUnit") || prompt("Enter your unit (e.g., 3B):");
localStorage.setItem("monitorUnit", unit);

const sessionId = `${Date.now()}-${Math.random().toString(36).slice(2)}`;

// Append messages to the live log with color coding
function appendToLog(message, type = "info") {
  const log = document.getElementById("liveLog");
  const div = document.createElement("div");
  div.classList.add("log-line");

  if (type === "success") div.classList.add("log-success");
  if (type === "failure") div.classList.add("log-failure");
  if (type === "info") div.classList.add("log-info");

  div.textContent = message;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// Send event to backend
async function logEvent(event) {
  try {
    await fetch("/log", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(event)
    });
  } catch (err) {
    appendToLog("✖ Failed to send log to server", "failure");
  }
}

// Ping logic with immediate failure logging
async function sendPing() {
  const start = performance.now();
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 3000); // 3s timeout

  try {
    const res = await fetch("/ping", { signal: controller.signal });
    clearTimeout(timeout);

    if (!res.ok) {
      appendToLog(`✖ Ping failed (${res.status})`, "failure");
      logEvent({
        eventType: "ping-failure",
        ok: false,
        status: res.status,
        latencyMs: null,
        timestamp: new Date().toISOString(),
        name,
        unit,
        sessionId
      });
      return;
    }

    const latency = Math.round(performance.now() - start);
    appendToLog(`✔ Ping ${latency} ms`, "success");

    logEvent({
      eventType: "ping",
      ok: true,
      status: res.status,
      latencyMs: latency,
      timestamp: new Date().toISOString(),
      name,
      unit,
      sessionId
    });

  } catch (err) {
    clearTimeout(timeout);
    appendToLog("✖ Ping failed (network error)", "failure");

    logEvent({
      eventType: "ping-failure",
      ok: false,
      status: "network-error",
      latencyMs: null,
      timestamp: new Date().toISOString(),
      name,
      unit,
      sessionId
    });
  }
}

// Online/offline events
window.addEventListener("online", () => {
  appendToLog("✔ Browser reports ONLINE", "success");
  logEvent({ eventType: "online-event", timestamp: new Date().toISOString(), name, unit, sessionId });
});

window.addEventListener("offline", () => {
  appendToLog("✖ Browser reports OFFLINE", "failure");
  logEvent({ eventType: "offline-event", timestamp: new Date().toISOString(), name, unit, sessionId });
});

// Start session
appendToLog("Starting monitoring…", "info");
logEvent({ eventType: "session-start", timestamp: new Date().toISOString(), name, unit, sessionId });

// Ping every 3 seconds
setInterval(sendPing, 3000);
</script>

</body>
</html>

