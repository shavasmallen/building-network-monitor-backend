<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Network Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui; margin: 2rem; }
    #liveLog {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      background: #fafafa;
      margin-top: 1rem;
    }
    .log-line { font-family: monospace; margin: 2px 0; }
    .log-success { color: #15803d; }
    .log-failure { color: #b91c1c; }
    .log-info { color: #1e3a8a; }

    .form-card {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      background: #fdfdfd;
      max-width: 400px;
    }
    label { display: block; margin-bottom: 0.3rem; }
    input {
      width: 100%;
      padding: 0.4rem;
      margin-bottom: 1rem;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    button {
      padding: 0.5rem 1rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>

<h1>Network Monitor</h1>
<p>Live connectivity and latency logging.</p>

<!-- ⭐ FORM FOR NAME + UNIT -->
<div class="form-card">
  <h3>Your Info</h3>
  <label for="nameInput">Name</label>
  <input id="nameInput" placeholder="e.g., Shava">

  <label for="unitInput">Unit</label>
  <input id="unitInput" placeholder="e.g., 4345 #2">

  <button onclick="startMonitoring()">Start Monitoring</button>
  <button onclick="downloadCSV()">Download My Data (CSV)</button>
</div>

<div>
  <strong>Status Log:</strong>
  <div id="liveLog"></div>
</div>

<script>
let name = null;
let unit = null;
let sessionId = null;
let monitoringStarted = false;
let localEvents = [];   // ⭐ store events for CSV export

// Local timestamp with milliseconds
function timestamp() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const HH = String(d.getHours()).padStart(2, "0");
  const MM = String(d.getMinutes()).padStart(2, "0");
  const SS = String(d.getSeconds()).padStart(2, "0");
  const ms = String(d.getMilliseconds()).padStart(3, "0");

  return `${yyyy}-${mm}-${dd} ${HH}:${MM}:${SS}.${ms}`;
}

// Append messages to the live log with color coding
function appendToLog(message, type = "info") {
  const log = document.getElementById("liveLog");
  const div = document.createElement("div");
  div.classList.add("log-line");

  if (type === "success") div.classList.add("log-success");
  if (type === "failure") div.classList.add("log-failure");
  if (type === "info") div.classList.add("log-info");

  div.textContent = `[${timestamp()}] ${message}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// Send event to backend + store locally
async function logEvent(event) {
  localEvents.push(event);

  try {
    await fetch("/log", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(event)
    });
  } catch (err) {
    appendToLog("✖ Failed to send log to server", "failure");
  }
}

// ⭐ Start monitoring after form submission
function startMonitoring() {
  name = document.getElementById("nameInput").value.trim();
  unit = document.getElementById("unitInput").value.trim();

  if (!name || !unit) {
    appendToLog("✖ Please enter both name and unit before starting.", "failure");
    return;
  }

  sessionId = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
  monitoringStarted = true;

  appendToLog(`✔ Monitoring started for ${name} (${unit})`, "success");

  logEvent({
    eventType: "session-start",
    timestamp: new Date().toISOString(),
    name,
    unit,
    sessionId
  });

  sendPing();
  setInterval(sendPing, 3000);
}

// Ping logic with immediate failure logging
async function sendPing() {
  if (!monitoringStarted) return;

  const start = performance.now();
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 3000);

  try {
    const res = await fetch("/ping", { signal: controller.signal });
    clearTimeout(timeout);

    if (!res.ok) {
      appendToLog(`✖ Ping failed (${res.status})`, "failure");
      logEvent({
        eventType: "ping-failure",
        ok: false,
        status: res.status,
        latencyMs: null,
        timestamp: new Date().toISOString(),
        name,
        unit,
        sessionId
      });
      return;
    }

    const latency = Math.round(performance.now() - start);
    appendToLog(`✔ Ping ${latency} ms`, "success");

    logEvent({
      eventType: "ping",
      ok: true,
      status: res.status,
      latencyMs: latency,
      timestamp: new Date().toISOString(),
      name,
      unit,
      sessionId
    });

  } catch (err) {
    clearTimeout(timeout);
    appendToLog("✖ Ping failed (network error)", "failure");

    logEvent({
      eventType: "ping-failure",
      ok: false,
      status: "network-error",
      latencyMs: null,
      timestamp: new Date().toISOString(),
      name,
      unit,
      sessionId
    });
  }
}

// Online/offline events
window.addEventListener("online", () => {
  if (!monitoringStarted) return;
  appendToLog("✔ Browser reports ONLINE", "success");
  logEvent({ eventType: "online-event", timestamp: new Date().toISOString(), name, unit, sessionId });
});

window.addEventListener("offline", () => {
  if (!monitoringStarted) return;
  appendToLog("✖ Browser reports OFFLINE", "failure");
  logEvent({ eventType: "offline-event", timestamp: new Date().toISOString(), name, unit, sessionId });
});

// ⭐ CSV Export
function downloadCSV() {
  if (localEvents.length === 0) {
    appendToLog("✖ No data to export yet.", "failure");
    return;
  }

  const headers = [
    "timestamp",
    "eventType",
    "ok",
    "status",
    "latencyMs",
    "name",
    "unit",
    "sessionId"
  ];

  const rows = localEvents.map(ev =>
    headers.map(h => JSON.stringify(ev[h] ?? "")).join(",")
  );

  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `network-monitor-${sessionId}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>

